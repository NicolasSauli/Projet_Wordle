<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordle Multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.3s ease-in-out; }
        @keyframes flip {
            0% { transform: rotateX(0); }
            50% { transform: rotateX(90deg); }
            100% { transform: rotateX(0); }
        }
        .flip { animation: flip 0.5s ease-in-out; }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.1s ease-in-out; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        .pulse-win { animation: pulse-green 1s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Auto-detect server address (works for localhost and network access)
        const HOST = window.location.hostname || 'localhost';
        const API_URL = `http://${HOST}:8000`;
        const WS_URL = `ws://${HOST}:8000`;

        const api = {
            async register(email, nom, prenom, password) {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, nom, prenom, password })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }
                return res.json();
            },
            async login(email, password) {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }
                return res.json();
            },
            async getStats(email) {
                const res = await fetch(`${API_URL}/stats/${email}`);
                return res.json();
            },
            async createLobby(nom, email) {
                const res = await fetch(`${API_URL}/lobby/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nom, email })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }
                return res.json();
            },
            async joinLobby(code, email) {
                const res = await fetch(`${API_URL}/lobby/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, email })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }
                return res.json();
            },
            async getLobby(code) {
                const res = await fetch(`${API_URL}/lobby/${code}`);
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }
                return res.json();
            }
        };

        const WordleApp = () => {
            const [page, setPage] = React.useState('home');
            const [user, setUser] = React.useState(null);
            const [lobby, setLobby] = React.useState(null);
            const [wordLength, setWordLength] = React.useState(5);
            const [tentatives, setTentatives] = React.useState([]);
            const [currentGuess, setCurrentGuess] = React.useState('');
            const [message, setMessage] = React.useState('');
            const [messageType, setMessageType] = React.useState('info');
            const [stats, setStats] = React.useState({ victoires: 0, parties: 0, meilleurScore: 0 });
            const [gameOver, setGameOver] = React.useState(false);
            const [loading, setLoading] = React.useState(false);
            const [ws, setWs] = React.useState(null);
            const [playersProgress, setPlayersProgress] = React.useState({});
            const [gameResults, setGameResults] = React.useState(null);
            const [isCreator, setIsCreator] = React.useState(false);

            React.useEffect(() => {
                const savedUser = localStorage.getItem('wordleUser');
                if (savedUser) {
                    const parsed = JSON.parse(savedUser);
                    setUser(parsed);
                    loadStats(parsed.email);
                    setPage('menu');
                }
            }, []);

            // Cleanup WebSocket on unmount
            React.useEffect(() => {
                return () => {
                    if (ws) {
                        ws.close();
                    }
                };
            }, [ws]);

            const loadStats = async (email) => {
                try {
                    const data = await api.getStats(email);
                    setStats(data);
                } catch (error) {
                    console.log('Error loading stats');
                }
            };

            const showMessage = (msg, type = 'info') => {
                setMessage(msg);
                setMessageType(type);
                setTimeout(() => setMessage(''), 3000);
            };

            const connectWebSocket = (lobbyCode, userEmail) => {
                const websocket = new WebSocket(`${WS_URL}/ws/${lobbyCode}/${userEmail}`);

                websocket.onopen = () => {
                    console.log('WebSocket connected');
                };

                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                setWs(websocket);
                return websocket;
            };

            const handleWebSocketMessage = (data) => {
                console.log('WS Message:', data);

                switch (data.type) {
                    case 'player_joined':
                        setLobby(prev => prev ? { ...prev, joueurs: data.joueurs } : prev);
                        showMessage(`${data.nom} a rejoint le lobby`, 'info');
                        break;

                    case 'player_left':
                        setLobby(prev => {
                            if (!prev) return prev;
                            return {
                                ...prev,
                                joueurs: prev.joueurs.filter(j => j.email !== data.email)
                            };
                        });
                        showMessage(`${data.nom} a quitte le lobby`, 'info');
                        break;

                    case 'game_started':
                        setWordLength(data.longueur);
                        setTentatives([]);
                        setCurrentGuess('');
                        setGameOver(false);
                        setGameResults(null);
                        setPlayersProgress({});
                        setPage('jeu');
                        showMessage('La partie commence!', 'success');
                        break;

                    case 'guess_result':
                        const newTentative = {
                            mot: data.correction.map(c => c.lettre).join(''),
                            correction: data.correction.map(c => c.etat)
                        };
                        setTentatives(prev => [...prev, newTentative]);

                        if (data.gagne) {
                            setGameOver(true);
                            showMessage(`Bravo! Trouve en ${data.tentatives_count} essais! +${data.score} points`, 'success');
                        } else if (data.perdu) {
                            setGameOver(true);
                            showMessage(`Perdu! Le mot etait: ${data.mot_secret}`, 'error');
                        }
                        break;

                    case 'player_progress':
                        setPlayersProgress(prev => ({
                            ...prev,
                            [data.email]: {
                                nom: data.nom,
                                tentatives: data.tentatives_count,
                                termine: data.termine,
                                gagne: data.gagne
                            }
                        }));
                        if (data.gagne) {
                            showMessage(`${data.nom} a trouve le mot!`, 'info');
                        }
                        break;

                    case 'game_ended':
                        setGameResults({
                            mot_secret: data.mot_secret,
                            results: data.results
                        });
                        setLobby(prev => prev ? { ...prev, joueurs: data.joueurs } : prev);
                        setGameOver(true);
                        break;

                    case 'error':
                        showMessage(data.message, 'error');
                        break;

                    case 'chat':
                        // Could implement chat display
                        break;
                }
            };

            const handleRegister = async (email, nom, prenom, password) => {
                setLoading(true);
                try {
                    const userData = await api.register(email, nom, prenom, password);
                    localStorage.setItem('wordleUser', JSON.stringify(userData));
                    setUser(userData);
                    setPage('menu');
                    showMessage(`Bienvenue ${prenom}!`, 'success');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogin = async (email, password) => {
                setLoading(true);
                try {
                    const userData = await api.login(email, password);
                    localStorage.setItem('wordleUser', JSON.stringify(userData));
                    setUser(userData);
                    await loadStats(userData.email);
                    setPage('menu');
                    showMessage(`Bon retour ${userData.prenom}!`, 'success');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                if (ws) {
                    ws.close();
                    setWs(null);
                }
                localStorage.removeItem('wordleUser');
                setUser(null);
                setLobby(null);
                setPage('home');
            };

            const handleCreateLobby = async (nomLobby) => {
                setLoading(true);
                try {
                    const lobbyData = await api.createLobby(nomLobby, user.email);
                    setLobby(lobbyData);
                    setIsCreator(true);
                    connectWebSocket(lobbyData.code, user.email);
                    setPage('lobby');
                    showMessage(`Lobby cree! Code: ${lobbyData.code}`, 'success');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleJoinLobby = async (code) => {
                setLoading(true);
                try {
                    const lobbyData = await api.joinLobby(code, user.email);
                    setLobby(lobbyData);
                    setIsCreator(lobbyData.createur === user.email);
                    connectWebSocket(code, user.email);
                    setPage('lobby');
                    showMessage('Lobby rejoint!', 'success');
                } catch (error) {
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleStartGame = () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'start_game' }));
                }
            };

            const handleSubmitGuess = () => {
                if (currentGuess.length !== wordLength) {
                    showMessage(`Le mot doit faire ${wordLength} lettres!`, 'error');
                    return;
                }

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'guess', guess: currentGuess }));
                    setCurrentGuess('');
                }
            };

            const handleKeyPress = (lettre) => {
                if (gameOver || loading) return;

                if (lettre === 'ENTER') {
                    handleSubmitGuess();
                } else if (lettre === 'BACK') {
                    setCurrentGuess(prev => prev.slice(0, -1));
                } else if (currentGuess.length < wordLength) {
                    setCurrentGuess(prev => prev + lettre);
                }
            };

            const handleLeaveLobby = () => {
                if (ws) {
                    ws.close();
                    setWs(null);
                }
                setLobby(null);
                setIsCreator(false);
                setPlayersProgress({});
                setGameResults(null);
                setPage('menu');
            };

            // Handle physical keyboard
            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    if (page !== 'jeu' || gameOver) return;

                    if (e.key === 'Enter') {
                        handleKeyPress('ENTER');
                    } else if (e.key === 'Backspace') {
                        handleKeyPress('BACK');
                    } else if (/^[a-zA-Z]$/.test(e.key)) {
                        handleKeyPress(e.key.toUpperCase());
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [page, gameOver, currentGuess, wordLength]);

            // Components
            const HomePage = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-bold text-gray-800 mb-2">WORDLE</h1>
                            <p className="text-gray-600">Multijoueur en temps reel</p>
                        </div>

                        <div className="space-y-4">
                            <button
                                onClick={() => setPage('register')}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition"
                            >
                                S'inscrire
                            </button>

                            <button
                                onClick={() => setPage('login')}
                                className="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition"
                            >
                                Se connecter
                            </button>
                        </div>
                    </div>
                </div>
            );

            const RegisterPage = () => {
                const [formData, setFormData] = React.useState({ email: '', nom: '', prenom: '', password: '' });

                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-600 to-teal-700 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-3xl font-bold text-gray-800 mb-6">Inscription</h2>

                            <div className="space-y-4">
                                <input
                                    type="email"
                                    placeholder="Email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                                />
                                <input
                                    type="text"
                                    placeholder="Nom"
                                    value={formData.nom}
                                    onChange={(e) => setFormData({...formData, nom: e.target.value})}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                                />
                                <input
                                    type="text"
                                    placeholder="Prenom"
                                    value={formData.prenom}
                                    onChange={(e) => setFormData({...formData, prenom: e.target.value})}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                                />
                                <input
                                    type="password"
                                    placeholder="Mot de passe"
                                    value={formData.password}
                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none"
                                />

                                <button
                                    onClick={() => formData.email && formData.nom && formData.prenom && formData.password && handleRegister(formData.email, formData.nom, formData.prenom, formData.password)}
                                    disabled={loading}
                                    className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition"
                                >
                                    {loading ? 'Chargement...' : 'Creer mon compte'}
                                </button>
                            </div>

                            <button
                                onClick={() => setPage('home')}
                                className="w-full mt-4 text-gray-600 hover:text-gray-800"
                            >
                                Retour
                            </button>
                        </div>
                    </div>
                );
            };

            const LoginPage = () => {
                const [formData, setFormData] = React.useState({ email: '', password: '' });

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-3xl font-bold text-gray-800 mb-6">Connexion</h2>

                            <div className="space-y-4">
                                <input
                                    type="email"
                                    placeholder="Email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                />
                                <input
                                    type="password"
                                    placeholder="Mot de passe"
                                    value={formData.password}
                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                    onKeyPress={(e) => e.key === 'Enter' && formData.email && formData.password && handleLogin(formData.email, formData.password)}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                />

                                <button
                                    onClick={() => formData.email && formData.password && handleLogin(formData.email, formData.password)}
                                    disabled={loading}
                                    className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition"
                                >
                                    {loading ? 'Chargement...' : 'Se connecter'}
                                </button>
                            </div>

                            <button
                                onClick={() => setPage('home')}
                                className="w-full mt-4 text-gray-600 hover:text-gray-800"
                            >
                                Retour
                            </button>
                        </div>
                    </div>
                );
            };

            const MenuPage = () => (
                <div className="min-h-screen bg-gradient-to-br from-purple-600 to-pink-700 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h2 className="text-3xl font-bold text-gray-800">Bienvenue {user?.prenom}!</h2>
                                    <p className="text-gray-600">{user?.email}</p>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="text-red-600 hover:text-red-800 font-semibold"
                                >
                                    Deconnexion
                                </button>
                            </div>

                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="bg-blue-100 p-4 rounded-lg text-center">
                                    <div className="text-3xl mb-2">üèÜ</div>
                                    <div className="text-2xl font-bold text-gray-800">{stats.victoires}</div>
                                    <div className="text-sm text-gray-600">Victoires</div>
                                </div>
                                <div className="bg-green-100 p-4 rounded-lg text-center">
                                    <div className="text-3xl mb-2">üéÆ</div>
                                    <div className="text-2xl font-bold text-gray-800">{stats.parties}</div>
                                    <div className="text-sm text-gray-600">Parties</div>
                                </div>
                                <div className="bg-yellow-100 p-4 rounded-lg text-center">
                                    <div className="text-3xl mb-2">‚≠ê</div>
                                    <div className="text-2xl font-bold text-gray-800">{stats.meilleurScore}</div>
                                    <div className="text-sm text-gray-600">Meilleur Score</div>
                                </div>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <button
                                onClick={() => setPage('createLobby')}
                                className="bg-white hover:bg-gray-50 rounded-2xl shadow-lg p-8 text-center transition"
                            >
                                <div className="text-5xl mb-4">üë•</div>
                                <h3 className="text-2xl font-bold text-gray-800 mb-2">Creer un Lobby</h3>
                                <p className="text-gray-600">Invitez vos amis a jouer</p>
                            </button>

                            <button
                                onClick={() => setPage('joinLobby')}
                                className="bg-white hover:bg-gray-50 rounded-2xl shadow-lg p-8 text-center transition"
                            >
                                <div className="text-5xl mb-4">üöÄ</div>
                                <h3 className="text-2xl font-bold text-gray-800 mb-2">Rejoindre un Lobby</h3>
                                <p className="text-gray-600">Entrez un code de lobby</p>
                            </button>
                        </div>
                    </div>
                </div>
            );

            const CreateLobbyPage = () => {
                const [nomLobby, setNomLobby] = React.useState('');

                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-blue-700 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-3xl font-bold text-gray-800 mb-6">Creer un Lobby</h2>

                            <input
                                type="text"
                                placeholder="Nom du lobby"
                                value={nomLobby}
                                onChange={(e) => setNomLobby(e.target.value)}
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none mb-4"
                            />

                            <button
                                onClick={() => nomLobby && handleCreateLobby(nomLobby)}
                                disabled={loading}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition mb-4"
                            >
                                {loading ? 'Chargement...' : 'Creer'}
                            </button>

                            <button
                                onClick={() => setPage('menu')}
                                className="w-full text-gray-600 hover:text-gray-800"
                            >
                                Retour
                            </button>
                        </div>
                    </div>
                );
            };

            const JoinLobbyPage = () => {
                const [code, setCode] = React.useState('');

                return (
                    <div className="min-h-screen bg-gradient-to-br from-teal-600 to-green-700 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <h2 className="text-3xl font-bold text-gray-800 mb-6">Rejoindre un Lobby</h2>

                            <input
                                type="text"
                                placeholder="Code du lobby (6 chiffres)"
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                maxLength={6}
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-teal-500 focus:outline-none mb-4 text-center text-2xl tracking-widest"
                            />

                            <button
                                onClick={() => code.length === 6 && handleJoinLobby(code)}
                                disabled={loading}
                                className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition mb-4"
                            >
                                {loading ? 'Chargement...' : 'Rejoindre'}
                            </button>

                            <button
                                onClick={() => setPage('menu')}
                                className="w-full text-gray-600 hover:text-gray-800"
                            >
                                Retour
                            </button>
                        </div>
                    </div>
                );
            };

            const LobbyPage = () => (
                <div className="min-h-screen bg-gradient-to-br from-orange-600 to-red-700 p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-8">
                            <div className="mb-6">
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">{lobby?.nom}</h2>
                                <div className="text-xl font-mono bg-gray-100 p-3 rounded-lg text-center">
                                    Code: <span className="font-bold text-orange-600">{lobby?.code}</span>
                                </div>
                                <p className="text-center text-gray-500 text-sm mt-2">Partagez ce code avec vos amis!</p>
                            </div>

                            <div className="mb-6">
                                <h3 className="text-xl font-bold text-gray-700 mb-3">
                                    Joueurs connectes ({lobby?.joueurs?.length || 0})
                                </h3>
                                <div className="space-y-2">
                                    {lobby?.joueurs?.map((joueur, idx) => (
                                        <div key={idx} className="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                                <span className="font-semibold">
                                                    {joueur.nom}
                                                    {joueur.email === lobby?.createur && (
                                                        <span className="text-xs text-orange-600 ml-2">(Hote)</span>
                                                    )}
                                                </span>
                                            </div>
                                            <span className="text-orange-600 font-bold">{joueur.score} pts</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {isCreator ? (
                                <button
                                    onClick={handleStartGame}
                                    className="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center gap-2 transition mb-4"
                                >
                                    Demarrer la partie
                                </button>
                            ) : (
                                <div className="w-full bg-gray-200 text-gray-600 font-semibold py-3 rounded-lg text-center mb-4">
                                    En attente du lancement par l'hote...
                                </div>
                            )}

                            <button
                                onClick={handleLeaveLobby}
                                className="w-full text-gray-600 hover:text-gray-800"
                            >
                                Quitter le lobby
                            </button>
                        </div>
                    </div>
                </div>
            );

            const JeuPage = () => {
                const clavier = [
                    ['A', 'Z', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
                    ['Q', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'M'],
                    ['ENTER', 'W', 'X', 'C', 'V', 'B', 'N', 'BACK']
                ];

                // Build letter status map from all attempts
                const getLetterStatus = () => {
                    const status = {};
                    tentatives.forEach(t => {
                        t.mot.split('').forEach((lettre, idx) => {
                            const etat = t.correction[idx];
                            if (etat === 'correct') {
                                status[lettre] = 'correct';
                            } else if (etat === 'present' && status[lettre] !== 'correct') {
                                status[lettre] = 'present';
                            } else if (etat === 'absent' && !status[lettre]) {
                                status[lettre] = 'absent';
                            }
                        });
                    });
                    return status;
                };

                const letterStatus = getLetterStatus();

                const getKeyColor = (lettre) => {
                    if (lettre === 'ENTER' || lettre === 'BACK') return 'bg-gray-400 hover:bg-gray-500';
                    const status = letterStatus[lettre];
                    if (status === 'correct') return 'bg-green-500 text-white';
                    if (status === 'present') return 'bg-yellow-500 text-white';
                    if (status === 'absent') return 'bg-gray-600 text-white';
                    return 'bg-gray-300 hover:bg-gray-400';
                };

                // Other players progress
                const otherPlayers = Object.entries(playersProgress).filter(([email]) => email !== user?.email);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-700 to-slate-900 p-4">
                        <div className="max-w-4xl mx-auto flex gap-4">
                            {/* Main game area */}
                            <div className="flex-1">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 mb-4">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold text-gray-800">WORDLE</h2>
                                        <div className="text-sm text-gray-600">
                                            Essai {Math.min(tentatives.length + 1, 6)}/6
                                        </div>
                                    </div>

                                    <div className="space-y-2 mb-6">
                                        {[...Array(6)].map((_, rowIdx) => (
                                            <div key={rowIdx} className="flex gap-2 justify-center">
                                                {[...Array(wordLength)].map((_, colIdx) => {
                                                    const tentative = tentatives[rowIdx];
                                                    const isCurrentRow = rowIdx === tentatives.length;
                                                    const lettre = tentative ? tentative.mot[colIdx] : (isCurrentRow ? currentGuess[colIdx] : '') || '';
                                                    const etat = tentative ? tentative.correction[colIdx] : '';

                                                    return (
                                                        <div
                                                            key={colIdx}
                                                            className={`w-14 h-14 border-2 rounded flex items-center justify-center text-2xl font-bold transition-all
                                                                ${etat === 'correct' ? 'bg-green-500 text-white border-green-500' : ''}
                                                                ${etat === 'present' ? 'bg-yellow-500 text-white border-yellow-500' : ''}
                                                                ${etat === 'absent' ? 'bg-gray-400 text-white border-gray-400' : ''}
                                                                ${!etat && lettre ? 'border-gray-400 pop' : 'border-gray-300'}
                                                            `}
                                                        >
                                                            {lettre}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>

                                    {gameResults && (
                                        <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                                            <h3 className="font-bold text-center mb-3">
                                                Partie terminee! Le mot etait: <span className="text-green-600">{gameResults.mot_secret}</span>
                                            </h3>
                                            <div className="space-y-2">
                                                {gameResults.results.map((r, idx) => (
                                                    <div key={idx} className={`flex justify-between items-center p-2 rounded ${idx === 0 ? 'bg-yellow-100' : 'bg-gray-100'}`}>
                                                        <span className="flex items-center gap-2">
                                                            {idx === 0 && 'üèÜ'}
                                                            {r.nom}
                                                            {r.gagne ? ` (${r.tentatives} essais)` : ' (perdu)'}
                                                        </span>
                                                        <span className="font-bold text-orange-600">{r.score} pts</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <button
                                                onClick={() => setPage('lobby')}
                                                className="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg"
                                            >
                                                Retour au lobby
                                            </button>
                                        </div>
                                    )}

                                    {gameOver && !gameResults && (
                                        <div className="mb-4 p-4 bg-gray-100 rounded-lg text-center">
                                            <p className="text-gray-600">En attente des autres joueurs...</p>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-white rounded-2xl shadow-2xl p-4">
                                    <div className="space-y-2">
                                        {clavier.map((row, idx) => (
                                            <div key={idx} className="flex gap-1 justify-center">
                                                {row.map((lettre) => (
                                                    <button
                                                        key={lettre}
                                                        onClick={() => handleKeyPress(lettre)}
                                                        disabled={gameOver || loading}
                                                        className={`
                                                            ${lettre === 'ENTER' || lettre === 'BACK' ? 'px-3 text-xs' : 'w-9'}
                                                            h-12 font-semibold rounded transition
                                                            ${getKeyColor(lettre)}
                                                            disabled:opacity-50 disabled:cursor-not-allowed
                                                        `}
                                                    >
                                                        {lettre === 'BACK' ? '‚å´' : lettre}
                                                    </button>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Side panel - Other players */}
                            {otherPlayers.length > 0 && (
                                <div className="w-64">
                                    <div className="bg-white rounded-2xl shadow-2xl p-4">
                                        <h3 className="font-bold text-gray-800 mb-3">Autres joueurs</h3>
                                        <div className="space-y-3">
                                            {otherPlayers.map(([email, data]) => (
                                                <div key={email} className={`p-3 rounded-lg ${data.gagne ? 'bg-green-100 pulse-win' : data.termine ? 'bg-red-100' : 'bg-gray-100'}`}>
                                                    <div className="font-semibold flex items-center gap-2">
                                                        {data.gagne && 'üèÜ'}
                                                        {data.termine && !data.gagne && '‚ùå'}
                                                        {data.nom}
                                                    </div>
                                                    <div className="text-sm text-gray-600">
                                                        {data.termine
                                                            ? (data.gagne ? `Trouve en ${data.tentatives} essais!` : 'Perdu')
                                                            : `Essai ${data.tentatives}/6`
                                                        }
                                                    </div>
                                                    {/* Progress bar */}
                                                    <div className="mt-2 flex gap-1">
                                                        {[...Array(6)].map((_, i) => (
                                                            <div
                                                                key={i}
                                                                className={`h-2 flex-1 rounded ${i < data.tentatives ? (data.gagne && i === data.tentatives - 1 ? 'bg-green-500' : 'bg-gray-400') : 'bg-gray-200'}`}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="relative">
                    {message && (
                        <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 font-semibold
                            ${messageType === 'success' ? 'bg-green-600 text-white' : ''}
                            ${messageType === 'error' ? 'bg-red-600 text-white' : ''}
                            ${messageType === 'info' ? 'bg-gray-800 text-white' : ''}
                        `}>
                            {message}
                        </div>
                    )}

                    {page === 'home' && <HomePage />}
                    {page === 'register' && <RegisterPage />}
                    {page === 'login' && <LoginPage />}
                    {page === 'menu' && <MenuPage />}
                    {page === 'createLobby' && <CreateLobbyPage />}
                    {page === 'joinLobby' && <JoinLobbyPage />}
                    {page === 'lobby' && <LobbyPage />}
                    {page === 'jeu' && <JeuPage />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WordleApp />);
    </script>
</body>
</html>
